name: Build SUSE Updater

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libfuse2 file desktop-file-utils
        
    - name: Setup AppImage Tool
      run: |
        wget https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
    - name: Prepare AppDir (Niess Python Base)
      run: |
        wget https://github.com/niess/python-appimage/releases/download/python3.9/python3.9.27-cp39-cp39-manylinux2014_x86_64.AppImage -O python.AppImage
        chmod +x python.AppImage
        ./python.AppImage --appimage-extract
        mv squashfs-root AppDir
        rm python.AppImage
        
    - name: Install Application
      run: |
        PYTHON=./AppDir/opt/python3.9/bin/python3.9
        PIP=./AppDir/opt/python3.9/bin/pip3.9
        $PYTHON -m pip install --upgrade pip
        $PIP install -r requirements.txt
        
    - name: Configure AppDir
      run: |
        mkdir -p AppDir/usr/bin
        # Copy source files
        cp -r main.py i18n.py update_checker.py updater_runner.py ui assets install_sudoers.sh AppDir/
        
        # Icon
        cp -f assets/icons/tray_green.svg AppDir/suse-updater.svg
        ln -sf suse-updater.svg AppDir/.DirIcon
        
        # Desktop Reference
        cat > AppDir/suse-updater.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=SUSE Updater
        Exec=suse-updater
        Icon=suse-updater
        Categories=System;Settings;
        Comment=Safe and simple updates for OpenSUSE Tumbleweed
        Terminal=false
        EOF
        
        # AppRun script
        find AppDir -name AppRun -delete
        cat > AppDir/AppRun <<'EOF'
        #!/bin/bash
        HERE=$(dirname "$(readlink -f "$0")")
        export PYTHONHOME="$HERE/opt/python3.9"
        export PYTHONPATH="$HERE/opt/python3.9/lib/python3.9/site-packages:$HERE"
        export PATH="$HERE/opt/python3.9/bin:$PATH"
        export LD_LIBRARY_PATH="$HERE/opt/python3.9/lib:$HERE/opt/python3.9/lib/python3.9/site-packages/PySide6/Qt/lib:$LD_LIBRARY_PATH"
        export QT_PLUGIN_PATH="$HERE/opt/python3.9/lib/python3.9/site-packages/PySide6/Qt/plugins"
        export QT_X11_NO_MITSHM=1
        exec "$HERE/opt/python3.9/bin/python3.9" "$HERE/main.py" "$@"
        EOF
        chmod +x AppDir/AppRun
        
    - name: Package AppImage
      env:
        ARCH: x86_64
      run: ./appimagetool-x86_64.AppImage AppDir SUSE-Updater-x86_64.AppImage

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SUSE-Updater-Linux
        path: SUSE-Updater-x86_64.AppImage
